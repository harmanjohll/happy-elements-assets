<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Responsive meta tag -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Happy Family: Periodic Table Edition</title>
  <!-- Google Fonts for modern look -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
  <style>
    /* Reset and global styles */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Roboto', sans-serif;
    }
    body {
      background: linear-gradient(135deg, #f6d365, #fda085);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }
    .game-container {
      background: #fff;
      width: 100%;
      max-width: 1000px;
      min-height: 850px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      padding: 20px;
      text-align: center;
    }
    header h1 {
      font-size: 2rem;
      margin-bottom: 5px;
      color: #333;
    }
    header p {
      font-size: 1rem;
      margin-bottom: 20px;
      color: #666;
    }
    #name-entry {
      margin-bottom: 20px;
    }
    #name-entry label,
    #name-entry input,
    #name-entry select,
    #name-entry button {
      font-size: 1rem;
      margin: 5px;
    }
    /* Player table using Flexbox */
    #table {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .player-seat {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      flex: 1 1 250px;
      max-width: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* Make the human player's seat span full width */
    #player-0 {
      flex: 1 1 100%;
      max-width: 100%;
    }
    .player-name {
      font-weight: 700;
      margin-bottom: 5px;
      color: #333;
    }
    .hand {
      width: 100%;
      background: #f9f9f9;
      border-radius: 5px;
      padding: 5px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      min-height: 60px;
      margin-bottom: 5px;
    }
    /* Human player's cards – larger for clarity */
    #player-0 .hand .card {
      width: 80px;
      height: 120px;
      margin: 5px;
    }
    /* Computer player's cards – grid layout remains unchanged */
    .hand.computer {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      justify-items: center;
    }
    .hand .card {
      width: 40px;
      height: 60px;
      margin: 2px;
    }
    .hand .card img {
      width: 100%;
      height: 100%;
      border-radius: 4px;
    }
    .completed-families {
      width: 100%;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 4px;
    }
    .completed-families img {
      width: 40px;
      height: 60px;
      border-radius: 4px;
    }
    /* Controls styling */
    #controls {
      margin-top: 20px;
    }
    #controls label,
    #controls select,
    #controls input,
    #controls button {
      font-size: 1rem;
      margin: 5px;
    }
    /* Log box styling */
    #log {
      margin-top: 20px;
      padding: 10px;
      background: #eef;
      border: 1px solid #99c;
      border-radius: 5px;
      font-size: 0.9rem;
      height: 150px;
      overflow-y: auto;
      text-align: left;
    }
    /* Responsive tweaks */
    @media (max-width: 768px) {
      header h1 {
        font-size: 1.75rem;
      }
      header p {
        font-size: 0.9rem;
      }
      #log {
        height: 120px;
      }
    }
    @media (max-width: 480px) {
      .player-seat {
        flex: 1 1 90%;
        max-width: 90%;
      }
      #player-0 .hand .card {
        width: 60px;
        height: 90px;
      }
      .hand .card {
        width: 35px;
        height: 50px;
      }
      #controls label,
      #controls select,
      #controls input,
      #controls button {
        font-size: 0.9rem;
      }
      #log {
        height: 100px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <header>
      <h1>Happy Family: Periodic Table Edition</h1>
      <p>Collect all the elements of the same group to form a family!</p>
    </header>
    <!-- Name entry and difficulty selection -->
    <div id="name-entry">
      <label for="player-name">Your Name:</label>
      <input type="text" id="player-name" placeholder="Enter your name">
      <label for="difficulty">Difficulty:</label>
      <select id="difficulty">
        <option value="beginner">Beginner</option>
        <option value="intermediate">Intermediate</option>
        <option value="advanced">Advanced</option>
      </select>
      <button id="start-game-button">Start Game</button>
    </div>
    <!-- Player seats container -->
    <div id="table" style="display: none;">
      <!-- Computer players -->
      <div id="player-1" class="player-seat">
        <div class="player-name" id="name-1">Computer 1</div>
        <div class="completed-families" id="completed-1"></div>
        <div class="hand computer" id="hand-1"></div>
      </div>
      <div id="player-2" class="player-seat">
        <div class="player-name" id="name-2">Computer 2</div>
        <div class="completed-families" id="completed-2"></div>
        <div class="hand computer" id="hand-2"></div>
      </div>
      <div id="player-3" class="player-seat">
        <div class="player-name" id="name-3">Computer 3</div>
        <div class="completed-families" id="completed-3"></div>
        <div class="hand computer" id="hand-3"></div>
      </div>
      <!-- Human player -->
      <div id="player-0" class="player-seat">
        <div class="player-name" id="name-0">You</div>
        <div class="completed-families" id="completed-0"></div>
        <div class="hand" id="hand-0">Your cards will appear here.</div>
      </div>
    </div>
    <!-- Controls container -->
    <div id="controls" style="display: none;">
      <div id="human-controls">
        <label for="target-player">Ask:</label>
        <select id="target-player"></select>
        <label for="card-choice">for:</label>
        <select id="card-choice"></select>
        <button id="ask-button">Ask</button>
      </div>
    </div>
    <!-- Log box -->
    <div id="log">
      <p><em>Game log...</em></p>
    </div>
  </div>
  
  <script>
    // Base URL for images on GitHub:
    const baseURL = 'https://raw.githubusercontent.com/harmanjohll/happy-elements-assets/refs/heads/main/images/';
    
    // Full card list: Groups 1,2,13,14 use .png; Groups 15-18 use .PNG.
    const fullCardList = [
      { group: 'Group 1', element: 'Lithium', img: baseURL + 'Li.png' },
      { group: 'Group 1', element: 'Sodium', img: baseURL + 'Na.png' },
      { group: 'Group 1', element: 'Potassium', img: baseURL + 'K.png' },
      { group: 'Group 1', element: 'Rubidium', img: baseURL + 'Rb.png' },
      { group: 'Group 2', element: 'Beryllium', img: baseURL + 'Be.png' },
      { group: 'Group 2', element: 'Magnesium', img: baseURL + 'Mg.png' },
      { group: 'Group 2', element: 'Calcium', img: baseURL + 'Ca.png' },
      { group: 'Group 2', element: 'Strontium', img: baseURL + 'Sr.png' },
      { group: 'Group 13', element: 'Boron', img: baseURL + 'B.png' },
      { group: 'Group 13', element: 'Aluminium', img: baseURL + 'Al.png' },
      { group: 'Group 13', element: 'Gallium', img: baseURL + 'Ga.png' },
      { group: 'Group 13', element: 'Indium', img: baseURL + 'In.png' },
      { group: 'Group 14', element: 'Carbon', img: baseURL + 'C.png' },
      { group: 'Group 14', element: 'Silicon', img: baseURL + 'Si.png' },
      { group: 'Group 14', element: 'Germanium', img: baseURL + 'Ge.png' },
      { group: 'Group 14', element: 'Tin', img: baseURL + 'Sn.png' },
      { group: 'Group 15', element: 'Nitrogen', img: baseURL + 'N.PNG' },
      { group: 'Group 15', element: 'Phosphorus', img: baseURL + 'P.PNG' },
      { group: 'Group 15', element: 'Arsenic', img: baseURL + 'As.PNG' },
      { group: 'Group 15', element: 'Antimony', img: baseURL + 'Sb.PNG' },
      { group: 'Group 16', element: 'Oxygen', img: baseURL + 'O.PNG' },
      { group: 'Group 16', element: 'Sulfur', img: baseURL + 'S.PNG' },
      { group: 'Group 16', element: 'Selenium', img: baseURL + 'Se.PNG' },
      { group: 'Group 16', element: 'Tellurium', img: baseURL + 'Te.PNG' },
      { group: 'Group 17', element: 'Fluorine', img: baseURL + 'F.PNG' },
      { group: 'Group 17', element: 'Chlorine', img: baseURL + 'Cl.PNG' },
      { group: 'Group 17', element: 'Bromine', img: baseURL + 'Br.PNG' },
      { group: 'Group 17', element: 'Iodine', img: baseURL + 'I.PNG' },
      { group: 'Group 18', element: 'Neon', img: baseURL + 'Ne.PNG' },
      { group: 'Group 18', element: 'Argon', img: baseURL + 'Ar.PNG' },
      { group: 'Group 18', element: 'Krypton', img: baseURL + 'Kr.PNG' },
      { group: 'Group 18', element: 'Xenon', img: baseURL + 'Xe.PNG' }
    ];
    
    // Mapping for Advanced mode (element name in lowercase -> group number)
    let elementToGroup = {};
    fullCardList.forEach(card => {
      elementToGroup[card.element.toLowerCase()] = card.group.replace("Group ", "");
    });
    
    // Global game state variables
    let players = [];
    let deck = [];
    let currentPlayerIndex = 0;
    let difficultyLevel = "beginner";
    
    // Helper functions for dropdown options
    function getUniqueElementOptions() {
      return fullCardList.map(card => card.element);
    }
    function populateCardChoiceDropdown(options) {
      const dropdown = document.getElementById('card-choice');
      dropdown.innerHTML = '';
      options.forEach(el => {
        let option = document.createElement('option');
        option.value = el;
        option.text = el;
        dropdown.appendChild(option);
      });
    }
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
    
    // Logging helper
    function logMessage(message) {
      console.log(message);
      const logDiv = document.getElementById('log');
      const p = document.createElement('p');
      p.innerHTML = message;
      logDiv.appendChild(p);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function getPlayerName(index) {
      if (index === 0) {
        const name = document.getElementById('player-name').value;
        return name.trim() !== "" ? name : "You";
      } else {
        return players[index].name;
      }
    }
    
    function updatePlayerDisplays() {
      const hand0 = document.getElementById('hand-0');
      hand0.innerHTML = '';
      players[0].hand.forEach(card => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card';
        cardDiv.innerHTML = `<img src="${card.img}" alt="${card.element}">`;
        hand0.appendChild(cardDiv);
      });
      for (let i = 1; i < players.length; i++) {
        const handDiv = document.getElementById('hand-' + i);
        handDiv.innerHTML = '';
        players[i].hand.forEach(() => {
          const cardDiv = document.createElement('div');
          cardDiv.className = 'card';
          cardDiv.innerHTML = `<img src="${baseURL}back-of-card.png" alt="card back">`;
          handDiv.appendChild(cardDiv);
        });
        handDiv.innerHTML += `<div style="font-size:14px; margin-top:4px;">(${players[i].hand.length} cards)</div>`;
      }
    }
    
    function updateCompletedDisplays() {
      for (let i = 0; i < players.length; i++) {
        const compDiv = document.getElementById('completed-' + i);
        compDiv.innerHTML = '';
        players[i].completedFamilies.forEach(group => {
          let imgSrc = '';
          if (group === 'Group 1') imgSrc = baseURL + 'Li.png';
          else if (group === 'Group 2') imgSrc = baseURL + 'Be.png';
          else if (group === 'Group 13') imgSrc = baseURL + 'B.png';
          else if (group === 'Group 14') imgSrc = baseURL + 'C.png';
          else if (group === 'Group 15') imgSrc = baseURL + 'N.PNG';
          else if (group === 'Group 16') imgSrc = baseURL + 'O.PNG';
          else if (group === 'Group 17') imgSrc = baseURL + 'F.PNG';
          else if (group === 'Group 18') imgSrc = baseURL + 'Ne.PNG';
          compDiv.innerHTML += `<img src="${imgSrc}" alt="${group}" style="width:40px; height:60px; margin:2px;">`;
        });
      }
    }
    
    function assignComputerNames() {
      let girlNames = ["Alice", "Beth", "Cathy", "Diana"];
      let boyNames = ["Charlie", "David", "Edward", "Frank"];
      girlNames.sort(() => Math.random() - 0.5);
      boyNames.sort(() => Math.random() - 0.5);
      players[1].name = girlNames[0];
      players[2].name = boyNames[0];
      players[3].name = girlNames[1];
      document.getElementById('name-1').textContent = players[1].name;
      document.getElementById('name-2').textContent = players[2].name;
      document.getElementById('name-3').textContent = players[3].name;
    }
    
    function updateTargetDropdown() {
      const dropdown = document.getElementById('target-player');
      dropdown.innerHTML = '';
      for (let i = 1; i <= 3; i++) {
        let option = document.createElement('option');
        option.value = i;
        option.text = players[i].name;
        dropdown.appendChild(option);
      }
    }
    
    function getUniqueElementOptions() {
      return fullCardList.map(card => card.element);
    }
    
    function populateCardChoiceDropdown(options) {
      const dropdown = document.getElementById('card-choice');
      dropdown.innerHTML = '';
      options.forEach(el => {
        let option = document.createElement('option');
        option.value = el;
        option.text = el;
        dropdown.appendChild(option);
      });
    }
    
    function shuffleDeck() {
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
    }
    
    function dealCards() {
      while (deck.length > 0) {
        for (let i = 0; i < players.length && deck.length > 0; i++) {
          players[i].hand.push(deck.pop());
        }
      }
    }
    
    // Update human controls based on difficulty.
    function updateHumanControls() {
      difficultyLevel = document.getElementById('difficulty').value;
      const container = document.getElementById('human-controls');
      if (difficultyLevel === "advanced") {
        container.innerHTML = `
          <label for="target-player">Ask:</label>
          <select id="target-player"></select>
          <label for="element-input">for element:</label>
          <input type="text" id="element-input" placeholder="Enter element">
          <label for="group-input">from Group:</label>
          <input type="text" id="group-input" placeholder="Enter group number">
          <button id="ask-button">Ask</button>
        `;
      } else {
        container.innerHTML = `
          <label for="target-player">Ask:</label>
          <select id="target-player"></select>
          <label for="card-choice">for:</label>
          <select id="card-choice"></select>
          <button id="ask-button">Ask</button>
        `;
        let options = getUniqueElementOptions();
        if (difficultyLevel === "intermediate") {
          shuffleArray(options);
        }
        populateCardChoiceDropdown(options);
      }
      updateTargetDropdown();
      document.getElementById('ask-button').addEventListener('click', handleAsk);
    }
    
    function handleAsk() {
      let targetIndex = parseInt(document.getElementById('target-player').value);
      if (difficultyLevel === "advanced") {
        let elementInput = document.getElementById('element-input').value.trim();
        let groupInput = document.getElementById('group-input').value.trim();
        processAskAdvanced(0, targetIndex, elementInput, groupInput);
      } else {
        let cardChoice = document.getElementById('card-choice').value;
        processAsk(0, targetIndex, cardChoice);
      }
    }
    
    // Process ask for beginner/intermediate modes.
    function processAsk(requesterIndex, targetIndex, elementName) {
      const requester = players[requesterIndex];
      const target = players[targetIndex];
      logMessage(getPlayerName(requesterIndex) + " asks " + getPlayerName(targetIndex) + " for " + elementName + ".");
      const cardPos = target.hand.findIndex(card => card.element === elementName);
      if (cardPos !== -1) {
        const card = target.hand.splice(cardPos, 1)[0];
        requester.hand.push(card);
        logMessage(getPlayerName(targetIndex) + " gives " + elementName + " to " + getPlayerName(requesterIndex) + ".");
        checkForFamily(requester);
        currentPlayerIndex = targetIndex;
      } else {
        logMessage(getPlayerName(targetIndex) + " says, 'Not at home!'");
        if (deck.length > 0) {
          const drawn = deck.pop();
          requester.hand.push(drawn);
          logMessage(getPlayerName(requesterIndex) + " draws a card.");
          checkForFamily(requester);
        }
        currentPlayerIndex = targetIndex;
      }
      updatePlayerDisplays();
      updateControls();
      checkGameEnd();
      if (currentPlayerIndex !== 0) {
        setTimeout(processComputerTurn, 1500);
      } else {
        logMessage("It's your turn.");
      }
    }
    
    // Process ask for advanced mode.
    function processAskAdvanced(requesterIndex, targetIndex, elementInput, groupInput) {
      const requester = players[requesterIndex];
      const target = players[targetIndex];
      let lowerElement = elementInput.toLowerCase();
      if (!elementToGroup[lowerElement] || elementToGroup[lowerElement] !== groupInput) {
        logMessage("Incorrect element or group. Please check your input.");
        return;
      }
      logMessage(getPlayerName(requesterIndex) + " asks " + getPlayerName(targetIndex) + " for " + elementInput + " from Group " + groupInput + ".");
      const cardPos = target.hand.findIndex(card => card.element.toLowerCase() === lowerElement);
      if (cardPos !== -1) {
        const card = target.hand.splice(cardPos, 1)[0];
        requester.hand.push(card);
        logMessage(getPlayerName(targetIndex) + " gives " + elementInput + " to " + getPlayerName(requesterIndex) + ".");
        checkForFamily(requester);
        currentPlayerIndex = targetIndex;
      } else {
        logMessage(getPlayerName(targetIndex) + " says, 'Not at home!'");
        if (deck.length > 0) {
          const drawn = deck.pop();
          requester.hand.push(drawn);
          logMessage(getPlayerName(requesterIndex) + " draws a card.");
          checkForFamily(requester);
        }
        currentPlayerIndex = targetIndex;
      }
      updatePlayerDisplays();
      updateControls();
      checkGameEnd();
      if (currentPlayerIndex !== 0) {
        setTimeout(processComputerTurn, 1500);
      } else {
        logMessage("It's your turn.");
      }
    }
    
    function updateControls() {
      if (currentPlayerIndex === 0) {
        updateHumanControls();
      }
      const humanControls = document.getElementById('human-controls');
      humanControls.style.display = currentPlayerIndex === 0 ? 'block' : 'none';
    }
    
    function checkForFamily(player) {
      const groupCount = {};
      player.hand.forEach(card => {
        groupCount[card.group] = (groupCount[card.group] || 0) + 1;
      });
      for (let group in groupCount) {
        if (groupCount[group] === 4) {
          player.hand = player.hand.filter(card => card.group !== group);
          player.completedFamilies.push(group);
          logMessage(getPlayerName(player.id) + " completed " + group + "!");
        }
      }
      updateCompletedDisplays();
    }
    
    function checkGameEnd() {
      const totalFamilies = players.reduce((sum, player) => sum + player.completedFamilies.length, 0);
      if (totalFamilies === 8) {
        let winner = players.reduce((prev, curr) => (prev.completedFamilies.length > curr.completedFamilies.length ? prev : curr));
        logMessage("Game Over! " + getPlayerName(winner.id) + " wins!");
        document.getElementById('human-controls').style.display = 'none';
      }
    }
    
    function processComputerTurn() {
      const computer = players[currentPlayerIndex];
      const possibleTargets = players.filter((p, idx) => idx !== currentPlayerIndex);
      const target = possibleTargets[Math.floor(Math.random() * possibleTargets.length)];
      const targetIndex = target.id;
      const randomElement = fullCardList[Math.floor(Math.random() * fullCardList.length)].element;
      logMessage(getPlayerName(currentPlayerIndex) + " (computer) asks " + getPlayerName(targetIndex) + " for " + randomElement + ".");
      const cardPos = target.hand.findIndex(card => card.element === randomElement);
      if (cardPos !== -1) {
        const card = target.hand.splice(cardPos, 1)[0];
        computer.hand.push(card);
        logMessage(getPlayerName(targetIndex) + " gives " + randomElement + " to " + getPlayerName(currentPlayerIndex) + ".");
        checkForFamily(computer);
        currentPlayerIndex = targetIndex;
      } else {
        logMessage(getPlayerName(targetIndex) + " says, 'Not at home!'");
        if (deck.length > 0) {
          const drawn = deck.pop();
          computer.hand.push(drawn);
          logMessage(getPlayerName(currentPlayerIndex) + " draws a card.");
          checkForFamily(computer);
        }
        currentPlayerIndex = targetIndex;
      }
      updatePlayerDisplays();
      updateControls();
      checkGameEnd();
      if (currentPlayerIndex !== 0) {
        setTimeout(processComputerTurn, 1500);
      } else {
        logMessage("It's your turn.");
      }
    }
    
    function shuffleDeck() {
      for (let i = deck.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [deck[i], deck[j]] = [deck[j], deck[i]];
      }
    }
    
    function dealCards() {
      while (deck.length > 0) {
        for (let i = 0; i < players.length && deck.length > 0; i++) {
          players[i].hand.push(deck.pop());
        }
      }
    }
    
    function assignComputerNames() {
      let girlNames = ["Alice", "Beth", "Cathy", "Diana"];
      let boyNames = ["Charlie", "David", "Edward", "Frank"];
      girlNames.sort(() => Math.random() - 0.5);
      boyNames.sort(() => Math.random() - 0.5);
      players[1].name = girlNames[0];
      players[2].name = boyNames[0];
      players[3].name = girlNames[1];
      document.getElementById('name-1').textContent = players[1].name;
      document.getElementById('name-2').textContent = players[2].name;
      document.getElementById('name-3').textContent = players[3].name;
    }
    
    function updateTargetDropdown() {
      const dropdown = document.getElementById('target-player');
      dropdown.innerHTML = '';
      for (let i = 1; i <= 3; i++) {
        let option = document.createElement('option');
        option.value = i;
        option.text = players[i].name;
        dropdown.appendChild(option);
      }
    }
    
    function initializeGame() {
      players = [];
      for (let i = 0; i < 4; i++) {
        players.push({ id: i, hand: [], completedFamilies: [] });
      }
      assignComputerNames();
      // Do not call updateTargetDropdown() here; it will be created later in updateHumanControls()
      deck = fullCardList.slice();
      shuffleDeck();
      dealCards();
      currentPlayerIndex = 0;
      document.getElementById('name-0').textContent = getPlayerName(0);
      difficultyLevel = document.getElementById('difficulty').value;
      logMessage("Game initialized. It's " + getPlayerName(currentPlayerIndex) + "'s turn.");
      updatePlayerDisplays();
      updateCompletedDisplays();
      updateControls();
    }
    
    document.getElementById('start-game-button').addEventListener('click', function() {
      initializeGame();
      document.getElementById('name-entry').style.display = 'none';
      document.getElementById('table').style.display = 'flex';
      document.getElementById('controls').style.display = 'block';
    });
    
    document.getElementById('player-name').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('start-game-button').click();
      }
    });
  </script>
</body>
</html>
